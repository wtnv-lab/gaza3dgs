<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3DGS Digital Archives | UTokyo & Partners</title>
    <style>
        /* CSSは変更ありません */
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #1a1a1a;
            color: #f0f0f0;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .iframe-wrapper {
            flex-grow: 1;
            position: relative;
            border: none;
        }

        #iframe-target,
        #iframe-target iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        #controls {
            padding: 12px;
            text-align: center;
            background-color: #2c2c2c;
            border-top: 1px solid #444;
            flex-shrink: 0;
            overflow-x: auto;
            white-space: nowrap;
        }

        #controls button {
            background-color: #4a4a4a;
            color: #ffffff;
            border: 1px solid #666;
            padding: 10px 18px;
            margin: 0 6px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s, transform 0.1s;
        }

        #controls button:hover {
            background-color: #5a5a5a;
        }

        #controls button.active {
            background-color: #007bff;
            border-color: #0056b3;
            transform: scale(1.05);
        }

        #info-box {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 300px;
            background-color: rgba(0, 0, 0, 0.75);
            border: 1px solid #555;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            max-height: calc(100% - 40px);
            overflow-y: auto;
        }

        #info-box h3 {
            margin-top: 0;
            font-size: 18px;
            color: #ffffff;
        }

        #info-box p {
            font-size: 14px;
            line-height: 1.6;
            color: #cccccc;
        }

        #info-box #credit-display {
            margin-top: 15px;
            font-size: 11px;
            color: #aaaaaa;
            border-top: 1px solid #444;
            padding-top: 10px;
        }

        #info-box #credit-display a {
            color: #8af;
            text-decoration: none;
        }

        #info-box #credit-display a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>

    <div class="app-container">
        <div class="iframe-wrapper">
            <div id="iframe-target"></div>
            <div id="info-box">
                <h3 id="info-title"></h3>
                <p id="info-description"></p>
                <div id="credit-display"></div>
            </div>
        </div>

        <div id="controls"></div>
    </div>

    <script>
        const contentData = [
            // Al Shifa Hospital
            {
                title: "People in Al Shifa Courtyard",
                description: "This 3D model shows displaced Palestinians receiving care in the courtyard of Al Shifa Hospital. Following repeated Israeli military raids, the hospital's main wards were severely damaged or destroyed, forcing patients and medical staff to use outdoor spaces for treatment.",
                src: "https://www.kiriengine.app/share/3dgsEmbed/1885843519059263488?userId=undefined?&bg_theme=dark",
                credit: "© UTokyo & Al Jazeera",
                needsReload: true,
                reloadSeconds: 26
            },
            {
                title: "Al Shifa Hospital Courtyard",
                description: "A view of the parking area within the Al Shifa Hospital courtyard, showing destroyed vehicles. The extensive damage to the complex illustrates the intensity of the attacks it sustained, which ultimately left Gaza's largest hospital non-functional.",
                src: "https://www.kiriengine.app/share/3dgsEmbed/1850871041102970880?userId=undefined?&bg_theme=dark",
                credit: "© UTokyo & Al Jazeera",
                needsReload: true,
                reloadSeconds: 26
            },
            {
                title: "Destroyed Entrance of Al Shifa Hospital",
                description: "This model captures the devastated main entrance and interior of Al Shifa Hospital. The scene reflects the aftermath of intense fighting and bombardment that left the medical facility in ruins.",
                src: "https://www.kiriengine.app/share/3dgsEmbed/1850870603406376960?userId=undefined?&bg_theme=dark",
                credit: "© UTokyo & Al Jazeera",
                needsReload: true,
                reloadSeconds: 26
            },
            {
                title: "Newborns Huddled for Care at Al Shifa",
                description: "This model shows several premature babies sharing a single bed for warmth and care at Al Shifa Hospital. Their specialized incubators became unusable due to power cuts and damage from military operations, forcing medical staff to improvise to keep them alive.",
                src: "https://lumalabs.ai/embed/433cd331-1f50-4077-8d77-34ef4173bd9e?mode=sparkles&background=%23ffffff&color=%23000000&showTitle=true&loadBg=true&logoPosition=bottom-left&infoPosition=bottom-right&cinematicVideo=undefined&showMenu=fals",
                credit: "© UTokyo & Al Jazeera",
                needsReload: false
            },
            {
                title: "Premature Babies in Improvised Care",
                description: "This model shows several premature babies sharing a single bed for warmth and care at Al Shifa Hospital. Their specialized incubators became unusable due to power cuts and damage from military operations, forcing medical staff to improvise to keep them alive.",
                src: "https://lumalabs.ai/embed/af474206-210c-43b7-bcf7-f963d6b04900?mode=sparkles&background=%23ffffff&color=%23000000&showTitle=true&loadBg=true&logoPosition=bottom-left&infoPosition=bottom-right&cinematicVideo=undefined&showMenu=false",
                credit: "© UTokyo & Al Jazeera",
                needsReload: false
            },
            {
                title: "Abandoned Nursery at Al Shifa Hospital",
                description: "The neonatal intensive care unit (NICU) at Al Shifa Hospital, now empty and non-functional. This room, once filled with life-saving equipment, stands as a stark testament to the collapse of the healthcare system in Gaza's largest hospital.",
                src: "https://lumalabs.ai/embed/8408d73d-04dc-4f6d-92f5-5efd2b3af5d0?mode=sparkles&background=%23ffffff&color=%23000000&showTitle=true&loadBg=true&logoPosition=bottom-left&infoPosition=bottom-right&cinematicVideo=undefined&showMenu=false",
                credit: "© UTokyo & Al Jazeera",
                needsReload: false
            },
            // Other areas
            {
                title: "Destroyed UN Vehicle in Bureij Camp",
                description: "A destroyed United Nations (UN) vehicle in the Bureij refugee camp. The original footage from UNRWA shows the aftermath of an attack on an aid convoy, highlighting the perilous conditions for humanitarian workers in the Gaza Strip.",
                src: "https://www.kiriengine.app/share/3dgsEmbed/1863133701328601088?userId=undefined?&bg_theme=bright",
                credit: '© UTokyo & <a href="https://www.instagram.com/p/C6b8L0pI-Sv/" target="_blank">UNRWA</a>',
                needsReload: true,
                reloadSeconds: 26
            },
            {
                title: "Destroyed Cityscape in Khan Yunis", // タイトルから (1) を削除
                description: "Widespread destruction in the city of Khan Yunis. This scene, captured by UNRWA, documents the extensive damage to residential buildings and urban infrastructure following prolonged Israeli military operations in the southern Gaza Strip.",
                src: "https://www.kiriengine.app/share/3dgsEmbed/1863739985128062976?userId=undefined?&bg_theme=dark",
                credit: "© UTokyo & UNRWA",
                needsReload: true,
                reloadSeconds: 26
            },
            {
                title: "Rubble and Ruins in Khan Yunis", // タイトルから (2) を削除し、より内容に沿ったものに
                description: "Another view of the devastation in Khan Yunis. The sheer scale of the destruction has made large parts of the city uninhabitable, creating a massive humanitarian and reconstruction challenge for the future.",
                src: "https://www.kiriengine.app/share/3dgsEmbed/1863737783344955392?userId=undefined?&bg_theme=dark",
                credit: "© UTokyo & UNRWA",
                needsReload: true,
                reloadSeconds: 26
            },
            {
                title: "Japan-Funded Overpass in Khan Yunis",
                description: "An overpass in Khan Yunis, built with development aid from the government of Japan. A sign on the bridge, written in Japanese, expresses gratitude for the support. This infrastructure was intended to improve local transportation and stood as a symbol of friendship before the recent conflict.",
                src: "https://lumalabs.ai/embed/6e0ba4f5-6a08-42ae-b048-9ddd9f801c98?mode=sparkles&background=%23ffffff&color=%23000000&showTitle=false&loadBg=true&logoPosition=bottom-left&infoPosition=top-left&cinematicVideo=undefined&showMenu=false",
                credit: '© UTokyo & <a href="https://www.unrwa.org/" target="_blank">UNRWA</a>',
                needsReload: false
            }
        ];

        const iframeTarget = document.getElementById('iframe-target');
        const controlsContainer = document.getElementById('controls');
        const infoTitle = document.getElementById('info-title');
        const infoDescription = document.getElementById('info-description');
        const creditDisplay = document.getElementById('credit-display');

        let reloadTimer = null;
        let currentContentIndex = 0;

        /**
         * iframeをクリーンに再生成する関数（メモリ解放を強化）
         */
        function recreateIframe(src) {
            const oldIframe = iframeTarget.firstChild;
            // 【改善①】古いiframeの内容を明示的に空にしてリソース解放を促す
            if (oldIframe) {
                oldIframe.src = 'about:blank';
            }

            // 少し遅延させることで、ブラウザがリソースを解放する猶予を与える
            setTimeout(() => {
                iframeTarget.innerHTML = '';

                const newIframe = document.createElement('iframe');
                newIframe.title = "3DGS Content";
                newIframe.setAttribute('allow', 'autoplay; fullscreen');
                newIframe.setAttribute('execution-while-out-of-viewport', '');
                newIframe.setAttribute('execution-while-not-rendered', '');

                iframeTarget.appendChild(newIframe);
                newIframe.src = src;
            }, 50); // 50msの遅延
        }

        /**
         * 【改善②】リロードタイマーを管理する関数
         */
        function manageReloadTimer() {
            // 既存のタイマーは常にクリア
            if (reloadTimer) {
                clearInterval(reloadTimer);
                reloadTimer = null;
            }

            // ページが非表示、または現在のコンテンツがリロード不要なら何もしない
            if (document.hidden || !contentData[currentContentIndex].needsReload) {
                return;
            }

            // ページが表示されていて、リロードが必要な場合のみタイマーを設定
            const data = contentData[currentContentIndex];
            reloadTimer = setInterval(() => {
                recreateIframe(data.src);
            }, data.reloadSeconds * 1000);
        }

        function changeContent(index) {
            if (index < 0 || index >= contentData.length) return;

            currentContentIndex = index;
            const data = contentData[index];

            // リロードタイマーの管理は専用関数に一任
            manageReloadTimer();

            recreateIframe(data.src);

            infoTitle.textContent = data.title;
            infoDescription.textContent = data.description;
            creditDisplay.innerHTML = data.credit;

            updateActiveButton();
        }

        function updateActiveButton() {
            const buttons = controlsContainer.querySelectorAll('button');
            buttons.forEach((button, index) => {
                if (index === currentContentIndex) {
                    button.classList.add('active');
                    button.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                } else {
                    button.classList.remove('active');
                }
            });
        }

        function initialize() {
            contentData.forEach((item, index) => {
                const button = document.createElement('button');
                button.textContent = item.title;
                button.onclick = () => changeContent(index);
                controlsContainer.appendChild(button);
            });

            if (contentData.length > 0) {
                changeContent(0);
            }

            // 【改善②】ページの表示・非表示を監視するイベントリスナーを設定
            document.addEventListener('visibilitychange', manageReloadTimer);
        }

        document.addEventListener('DOMContentLoaded', initialize);
    </script>

</body>

</html>